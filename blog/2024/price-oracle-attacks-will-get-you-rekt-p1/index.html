<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Price Oracle Attacks Will Get You Rekt, P.1 | Alex Perez (reentrant)</title> <meta name="author" content="Alex Perez"> <meta name="description" content="What could go wrong when using trusted price feeds?"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://0xreentrant.github.io/blog/2024/price-oracle-attacks-will-get-you-rekt-p1/"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Price Oracle Attacks Will Get You Rekt, P.1",
      "description": "What could go wrong when using trusted price feeds?",
      "published": "May 1, 2024",
      "authors": [
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Alex Perez (reentrant)</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>Price Oracle Attacks Will Get You Rekt, P.1</h1> <p>What could go wrong when using trusted price feeds?</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#price-oracle-attacks-will-get-you-rekt">Price Oracle Attacks Will Get You Rekt</a></div> <div><a href="#a-common-tool-and-a-common-attack">A Common Tool and a Common Attack</a></div> <div><a href="#what-makes-a-price-oracle-attack">What makes a Price Oracle attack</a></div> <div><a href="#price-oracle-attacks-by-example">Price Oracle Attacks by Example</a></div> <div><a href="#inverse-finance-a-calculated-attack-with-a-small-pool">Inverse Finance - a Calculated Attack with a Small Pool</a></div> <div><a href="#the-price-manipulation-leverage">The Price Manipulation - Leverage</a></div> <div><a href="#small-pool-big-pressure">Small Pool Big Pressure</a></div> <div><a href="#exploiting-the-weak-oracle">Exploiting the Weak Oracle</a></div> <div><a href="#the-missing-link-mev">The missing link - MEV</a></div> <div><a href="#lessons-learned">Lessons Learned</a></div> <div><a href="#poor-choices-and-missed-chances">Poor choices and missed chances</a></div> <div><a href="#sushiswap-the-low-liquidity-pool-danger">SushiSwap - the low-liquidity pool danger</a></div> <div><a href="#keep3r-oracle-design-unused-oracles">Keep3r Oracle Design - Unused Oracles</a></div> <div><a href="#keep3r-twap-tradeoffs">Keep3r TWAP - Tradeoffs</a></div> <div><a href="#keep3r-s-freshness-function-a-volatility-sieve">Keep3r's Freshness function - a volatility sieve</a></div> <div><a href="#keep3r-vulnerability-computing-with-canceled-terms">Keep3r Vulnerability - computing with canceled terms</a></div> <div><a href="#aftermath">Aftermath</a></div> <div><a href="#what-to-ask-for-next-time">What to ask for next time</a></div> </nav> </d-contents> <blockquote> <p><strong>NOTE:</strong> This article assumes the reader has experience with DeFi products and smart contract development, but little substantial security or auditing experience.</p> </blockquote> <p>Today we’re going to explore Price Oracle Attacks. In the proceeding exploration, take time to follow the included links for more background information. I’d like to make sure you can follow along with me.</p> <h1 id="price-oracle-attacks-will-get-you-rekt">Price Oracle Attacks Will Get You Rekt</h1> <p>DeFi has seen, in real money, over $8,000,000,000, lost in hacks. You’ve probably been a victim. If you’ve released anything within the DeFi ecosystem, you might have had it happen to you. During this series, we’ll explain the one technique used to perform these hacks. In this part, we’ll be looking specifically at a noteworthy hack on Inverse Finance.</p> <h2 id="a-common-tool-and-a-common-attack">A Common Tool and a Common Attack</h2> <p>Inverse Finance’s Frontier protocol was <a href="https://rekt.news/inverse-finance-rekt/" rel="external nofollow noopener" target="_blank">hacked on April 2nd, 2022 for $15.6m</a> using a <a href="https://ethereum.org/en/developers/docs/oracles/" rel="external nofollow noopener" target="_blank">Price Oracle</a> attack.</p> <p>Price oracle attacks are among the top 10 types of hacks <a href="https://medium.com/immunefi/the-top-10-most-common-vulnerabilities-in-web3-bf7a921d489f#:~:text=V03%3A2023%20Oracle/Price%20Manipulation" rel="external nofollow noopener" target="_blank">according to Immunifi</a>. To underscore how high the cost is, consider that the <a href="https://rekt.news/mango-markets-rekt/" rel="external nofollow noopener" target="_blank">two</a> <a href="https://rekt.news/cream-rekt-2/" rel="external nofollow noopener" target="_blank">costliest</a> price oracle attacks account for $245,000,000 lost in DeFi alone. Why this keeps happening is that getting useful price feeds in DeFi is not a solved problem, and so developers face trade-offs in providing useful price feeds when building protocols. Popular CeFi exchange Coinbase <a href="https://www.coinbase.com/blog/introducing-the-coinbase-price-oracle" rel="external nofollow noopener" target="_blank">judges the problem clearly</a>:</p> <blockquote> <p>There are two main approaches to making asset prices available for DeFi: publishing signed price data from an off-chain source like an exchange, or using prices from algorithmic decentralized exchanges (DEXes) such as Uniswap or Kyber.</p> <p>Unfortunately, both suffer from major problems. Using data from an off-chain source requires trusting the publisher to post correct prices and keep the signing key safe — the latter historically has proven to be a difficult problem, especially when stakes are high. Similarly, relying on DEX-generated on-chain feeds exposes protocols to various novel attack vectors yet to be fully explored.</p> </blockquote> <p>Oracles rely on data that might require off-chain trust. Or reliance on potentially faulty on-chain calculations from 3rd-parties. Simply put, a bad price oracle means a bad financial calculation - anathema to the whole concept of accounting.</p> <h3 id="what-makes-a-price-oracle-attack">What makes a Price Oracle attack</h3> <p>It’s leveraging the tradeoffs an oracle chooses. For example, an oracle might need to get the most up-to-date price, but because their prices are determined strictly by reserve ratios, the price is liable to be manipulated by a motivated attacker when the pool liquidity is sufficiently low. As an opposing example, if an oracle is configured to smooth out volatility in prices by taking averages across a long time span, then prices might not reflect true market value. To find a middle ground, some oracles take an average of multiple values. As this first Price Oracle attack is explained, it’ll become clear that vulnerabilities can still emerge.</p> <h2 id="price-oracle-attacks-by-example">Price Oracle Attacks by Example</h2> <p>Price Oracle attacks had <a href="https://defillama.com/hacks" rel="external nofollow noopener" target="_blank">been done before</a> in DeFi. It wouldn’t even be the last time our protocol in question would be hacked. But, in spite of millions on the line, it happened, all because Inverse Finance missed a vulnerability in how their assets were priced.</p> <p>To explain, we’ll describe the vulnerability, then explore how it all came together.</p> <h3 id="inverse-finance---a-calculated-attack-with-a-small-pool">Inverse Finance - a Calculated Attack with a Small Pool</h3> <p>Here’s the bottom line for the Inverse hack. As <a href="https://www.coindesk.com/tech/2022/04/02/defi-lender-inverse-finance-exploited-for-156-million/" rel="external nofollow noopener" target="_blank">reported by Coindesk</a>:</p> <blockquote> <p>According to blockchain security firm <a href="https://twitter.com/peckshield/status/1510232640338608131" rel="external nofollow noopener" target="_blank">PeckShield</a>, the Inverse attacker took advantage of a vulnerability in a <a href="https://andrecronje.medium.com/keep3r-v2-oracles-8895f107561b" rel="external nofollow noopener" target="_blank">Keep3r price oracle</a> Inverse uses to track token prices. The attacker tricked the oracle into thinking that the price of Inverse’s INV token was extraordinarily high, and then took out multimillion-dollar loans on Anchor using the inflated INV as collateral.</p> </blockquote> <p>Specifically:</p> <ol> <li>The price of the INV token came from the INV/WETH pool on SushiSwap, which forked the <a href="https://docs.uniswap.org/contracts/v2/concepts/core-concepts/pools" rel="external nofollow noopener" target="_blank">Uniswap v2 Pool</a>. This pool provided a price oracle that used <a href="https://docs.uniswap.org/contracts/v2/concepts/core-concepts/oracles" rel="external nofollow noopener" target="_blank">time-weighted average prices</a> (TWAP) available to 3rd-parties. This oracle’s price was safe from manipulation, <a href="https://docs.uniswap.org/contracts/v2/concepts/core-concepts/oracles#:~:text=the%20cost%20of%20manipulation%20increases%20(approx.%20linear)%20with%20liquidity%20on%20Uniswap%2C%20as%20well%20as%20(approx.%20linear)%20with%20the%20length%20of%20time%20over%20which%20you%20average" rel="external nofollow noopener" target="_blank">as long as there was enough liquidity</a> in a pool to make the attack too expensive.</li> <li>The INV/ETH pool did not have enough liquidity to defend against a price manipulation attack.</li> <li>Inverse Finance’s lending pools used <a href="https://keep3r.network/" rel="external nofollow noopener" target="_blank">the Keep3r network</a> to retrieve the prices from the SushiSwap. This oracle would only use the most up-to-date prices as long as the difference in time between the SushiSwap pool last record and Keep3r’s last record <a href="https://inspexco.medium.com/inverse-finances-incident-analysis-inv-price-manipulation-b15c2e917888#:~:text=2%E2%80%99s%20wallet.-,Root%20Cause%20Analysis,-The%20core%20oracle" rel="external nofollow noopener" target="_blank">were not equal</a>.</li> <li>The attacker made sure the time difference between both records were equal.</li> </ol> <p>Despite the obstacles put in place by Uniswap’s V2 TWAP design, cloned by SushiSwap, as well as the layer provided by Keep3r’s oracle, INV was price manipulated - the oracles in place could not defend against the attack.</p> <p>Let’s run through the key factors of the attack scenario before we discuss the implementation details. That way we’ll be able to see why each piece of the vulnerability made the attack possible.</p> <h3 id="the-price-manipulation---leverage">The Price Manipulation - Leverage</h3> <p>Recall that the Uniswap V2 AMM uses a<a href="https://docs.uniswap.org/contracts/v2/concepts/protocol-overview/how-uniswap-works#:~:text=Pairs%20act%20as%20automated%20market%20makers" rel="external nofollow noopener" target="_blank"> constant product formula</a> to price its assets. In this case, when a pool has limited liquidity, the constant product formula provides prices with much greater slippage. From the <a href="https://docs.uniswap.org/contracts/v2/concepts/protocol-overview/how-uniswap-works#:~:text=This%20formula%20has%20the%20desirable%20property%20that%20larger%20trades%20(relative%20to%20reserves)%20execute%20at%20exponentially%20worse%20rates%20than%20smaller%20ones." rel="external nofollow noopener" target="_blank">Uniswap docs</a>:</p> <blockquote> <p>This formula has the desirable property that larger trades (relative to reserves) execute at exponentially worse rates than smaller ones.</p> </blockquote> <p>For the low-liquidity WETH/INV pool, the INV received after the swap removed so much liquidity that its price in that pool skyrocketed. Any protocols using the price of INV according to that pool would now report this manipulated price nearly 50x higher than originally.</p> <p>Study the figure below:</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/inverse_attacker_manipulation-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/inverse_attacker_manipulation-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/inverse_attacker_manipulation-1400.webp"></source> <img src="/assets/img/inverse_attacker_manipulation.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In the first step, <a href="https://app.blocksec.com/explorer/tx/eth/0x20a6dcff06a791a7f8be9f423053ce8caee3f9eecc31df32445fc98d4ccd8365?line=9" rel="external nofollow noopener" target="_blank">a low liquidity pool’s was targeted (WETH/INV)</a>, and was manipulated by swapping 300 WETH. This caused the price of INV to jump from 0.106 WETH (about $366) to 5.966 WETH (about $20,583), <a href="https://www.oklink.com/academy/en/2022/07/12/hot-inverse-finance-loses-over-15m-in-oracle-manipulation#:~:text=INV%20price%20from-,0.106%20WETH%20(about%20%24366)%20to%205.966%20WETH%20(about%20%2420%2C583),-in%20the%20WETH" rel="external nofollow noopener" target="_blank">according to analytics firm OKLINK’s report</a></p> <p>The fund flow highlighted area shown below is the key price manipulation.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/inverse_attacker_swap_flow-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/inverse_attacker_swap_flow-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/inverse_attacker_swap_flow-1400.webp"></source> <img src="/assets/img/inverse_attacker_swap_flow.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h4 id="small-pool-big-pressure">Small Pool Big Pressure</h4> <p>The big question is then, “Why is INV/WETH the target when there were other pools around?” In fact, our attacker did swap for vastly more INV using the INV/DOLA pool. However, when we inspect the Inverse Finance lending contract on Etherscan we can see it uses the INV/WETH pool TWAP to determine an account’s liquidity:</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/keep3r_oracle_pool-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/keep3r_oracle_pool-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/keep3r_oracle_pool-1400.webp"></source> <img src="/assets/img/keep3r_oracle_pool.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The attacker knew that loan withdrawals using INV were priced internally by checking the INV/WETH pool prices, and that the INV/WETH pool had dangerously low liquidity.</p> <p>When it comes to price oracle attacks, <a href="https://chain.link/education-hub/market-manipulation-vs-oracle-exploits#:~:text=Oracle%20Exploit%20as%20a%20Result%20of%20Poor%20Market%20Coverage" rel="external nofollow noopener" target="_blank">Chainlink describes this instance best</a>:</p> <blockquote> <p>Poor market coverage can lead to oracles misreporting the price of an asset. Relying on only a subset of all trading environments makes them vulnerable to an oracle exploit if that subset is manipulated, even when the majority of trading environments and the market-wide price remain unaffected.</p> <p>For example, if an asset is traded across five exchanges and 85% of trading volume takes place on two of those exchanges, relying on the other three low-liquidity exchanges for price inputs would give the oracle poor market coverage. If a malicious actor manipulated the price on those three low-liquidity exchanges, then the oracle would report a price that differs from the actual market-wide price, leading to possible exploits.</p> </blockquote> <p>Inverse Finance’s oracles had wildly poor market coverage. We’ll see that ultimately only a single market was considered.</p> <h3 id="exploiting-the-weak-oracle">Exploiting the Weak Oracle</h3> <p><a href="https://app.blocksec.com/explorer/tx/eth/0x600373f67521324c8068cfd025f121a0843d57ec813411661b07edc5ff781842" rel="external nofollow noopener" target="_blank">For the first block of the attack, the price of INV has been manipulated near 50x higher</a>. What happens in the next block is shown in the diagram below:</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/inverse_attacker_theft-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/inverse_attacker_theft-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/inverse_attacker_theft-1400.webp"></source> <img src="/assets/img/inverse_attacker_theft.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Since Sushi’s pools use the Uniswap V2 TWAP, the attacker must wait until the next block to ensure the manipulated price becomes the pool’s actual price. After manually forcing the pool to do so with <a href="https://github.com/Uniswap/v2-core/blob/ee547b17853e71ed4e0101ccfd52e70d5acded58/contracts/UniswapV2Pair.sol#L197-L200" rel="external nofollow noopener" target="_blank">sync</a>, the attacker takes his profits by depositing their INV and withdrawing all the funds from Inverse’s lending pools, netting themselves roughly $15.6 million in stolen funds.</p> <h2 id="the-missing-link---mev">The missing link - MEV</h2> <p>If you’ve been reading and wondering, “How did this guy get away with the attack without be arbitraged to oblivion?” I won’t be <a href="https://twitter.com/bertcmiller/status/1510284763332071427" rel="external nofollow noopener" target="_blank">exploring the details</a> here but the high level summary is this:</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/inverse_attacker_spam-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/inverse_attacker_spam-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/inverse_attacker_spam-1400.webp"></source> <img src="/assets/img/inverse_attacker_spam.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The attacker knows that MEV bots and arbitrageurs are waiting for price discrepancies. To protect against their manipulation getting arbitraged they opted to hide their transaction by directly sending it as a bundle using Flashbots.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/inverse_attacker_bundle-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/inverse_attacker_bundle-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/inverse_attacker_bundle-1400.webp"></source> <img src="/assets/img/inverse_attacker_bundle.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="lessons-learned">Lessons Learned</h2> <p>Let’s walk in the shoes of the devs and roleplay them in a room, the second after the incident.</p> <p>“Why could the attacker do this?” “What assumptions did they break wide open?” “How can we protect ourselves next time?”</p> <h3 id="poor-choices-and-missed-chances">Poor choices and missed chances</h3> <p>Let’s look at the actual oracles in play for this Price Oracle attack. To be clear, the oracles themselves are battle-tested across a wide range of use-cases. It was how they were utilized and the conditions around them that created the vulnerability.</p> <p>There has been some hand-waving used to simplify the explanation: the Keep3r oracle was designed to use multiple price feeds, and not just the one SushiSwap pool we described in the attack. In fact, the oracle was configure to query both Uniswap and SushiSwap INV/WETH pools for prices.</p> <p>How is that true, yet still our attacker still exploits the protocol?</p> <h4 id="sushiswap---the-low-liquidity-pool-danger">SushiSwap - the low-liquidity pool danger</h4> <p>It all begins with the price manipulation on the low-liquidity INV/WETH pool. By leaning on this pool for such a critical function as computing prices of lending pool, the protocol opened the door for a motivated attacker to control how much they could withdraw from Inverse, in bad faith. A single big trade, and the price moves dramatically.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/amm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/amm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/amm-1400.webp"></source> <img src="/assets/img/amm.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h4 id="keep3r-oracle-design---unused-oracles">Keep3r Oracle Design - Unused Oracles</h4> <p>In our scenario, Inverse used a <a href="https://github.com/keep3r-network/keep3r.network/blob/a6897007db6e656e0e310ed7ee4ad42904fe2794/contracts/Keep3rV2OracleFactory.sol#L23C10-L23C24" rel="external nofollow noopener" target="_blank">Keep3r V2 Oracle</a> as the final say in their price feed strategy. In front of that were feeds from a couple of INV/WETH pools as we’ll see.</p> <p><a href="https://app.blocksec.com/explorer/tx/eth/0x20a6dcff06a791a7f8be9f423053ce8caee3f9eecc31df32445fc98d4ccd8365?line=20&amp;debugLine=20" rel="external nofollow noopener" target="_blank">Looking into the transaction at the time of the attack</a>, we can see there are two feeds, and each feed’s pair ends up being:</p> <ol> <li><a href="https://etherscan.io/address/0x73E02EAAb68a41Ea63bdae9Dbd4b7678827B2352#readContract" rel="external nofollow noopener" target="_blank">Uniswap INV/ETH</a></li> <li><a href="https://etherscan.io/address/0x328dFd0139e26cB0FEF7B0742B49b0fe4325F821#readContract" rel="external nofollow noopener" target="_blank">SushiSwap INV/ETH</a></li> </ol> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/price_feeds-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/price_feeds-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/price_feeds-1400.webp"></source> <img src="/assets/img/price_feeds.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We’d imagine this to to be helpful in the protocol’s defense, if they both contributed to protecting the INV price. That that is not the case. We’ll take note of this while thinking through a key mechanism in the oracle: how Keep3r’s TWAP prices are updated.</p> <h4 id="keep3r-twap---tradeoffs">Keep3r TWAP - Tradeoffs</h4> <blockquote> <p>NOTE: Keep3r V2 oracles use the same interface as <a href="https://docs.uniquote.finance/" rel="external nofollow noopener" target="_blank">Keep3r V1 oracles</a></p> </blockquote> <p>There are two major considerations when it comes to price feeds: Freshness and Security. For the Keep3r V2 oracle, <a href="https://docs.uniquote.finance/#price-feeds" rel="external nofollow noopener" target="_blank">there are two functions that correspond to either consideration:</a></p> <ul> <li>Freshness: <code class="language-plaintext highlighter-rouge">current()</code> </li> </ul> <pre><code class="language-solidity">// returns the amount out corresponding to the amount in for a given token using the moving average over the time
function current(address tokenIn, uint amountIn, address tokenOut) external view returns (uint amountOut)
</code></pre> <p>This generates a simple TWAP using the difference between the actual pool’s TWAP and the last price records by the pool and Keep3r oracle. Essentially:</p> \[\text{amountOut} = \text{amountIn} \times \frac{\text{pool.price0CumulativeLast} - \text{lastObservation.price0Cumulative}}{\text{pool.lastCumulativePriceTimestamp} - \text{observation.lastObservationTimestamp}}\] <ul> <li>Security: <code class="language-plaintext highlighter-rouge">quote()</code> </li> </ul> <pre><code class="language-solidity">// returns the amount out corresponding to the amount in for a given token using the moving average over the time taking granularity samples
function quote(address tokenIn, uint amountIn, address tokenOut, uint granularity) external view returns (uint amountOut)
</code></pre> <p>This second function creates its own TWAP by averaging the accumulated price observations itself. It supports an arbitrary “lookback” window (<code class="language-plaintext highlighter-rouge">granularity</code>), enabling callers to adjust their TWAP according to the desired level of volatility.</p> <p>Outlining the concept is the averaging logic:</p> <pre><code class="language-solidity">for (; i &lt; _length; i++) {
    nextIndex = i+1;
    currentObservation = observations[i];
    nextObservation = observations[nextIndex];
    priceAverageCumulative += _computeAmountOut(
        currentObservation.price0Cumulative,
        nextObservation.price0Cumulative,
        nextObservation.timestamp - currentObservation.timestamp, amountIn);
}
</code></pre> <p>This looks like the function one would like to use in the case of a price manipulation attack. This is not the case for Inverse Finance’s lending platform, and <code class="language-plaintext highlighter-rouge">current()</code> is used instead.</p> <p>Security is traded for Freshness. What ends up aiding the attacker is that Freshness allows the extreme spike in the manipulated price to affect Inverse’s lending rates.</p> <h4 id="keep3rs-freshness-function---a-volatility-sieve">Keep3r’s Freshness function - a volatility sieve</h4> <p><code class="language-plaintext highlighter-rouge">current()</code> <a href="https://github.com/keep3r-network/keep3r.network/blob/a6897007db6e656e0e310ed7ee4ad42904fe2794/contracts/Keep3rV2OracleFactory.sol#L90-L111" rel="external nofollow noopener" target="_blank">samples a single observation and computes the latest data from the pool TWAP</a>. For the purpose of freshness this is essential.</p> <pre><code class="language-solidity">uint price0Cumulative = IUniswapV2Pair(pair).price0CumulativeLast() * e10 / Q112;

// later, compute the price...

amountOut = _computeAmountOut(_observation.price0Cumulative, price0Cumulative, timeElapsed, amountIn);
</code></pre> <p>However, in the case that a pool’s price is manipulated artificially, that manipulated price will pass through to the oracle’s caller with little change compared to a more robust sampling of market prices.</p> <p>Worse, any defense <code class="language-plaintext highlighter-rouge">current()</code> provided against volatility through Keep3r observations is nullified by a vulnerability to stale observations.</p> <h4 id="keep3r-vulnerability---computing-with-canceled-terms">Keep3r Vulnerability - computing with canceled terms</h4> <p>The <a href="https://github.com/keep3r-network/keep3r.network/blob/a6897007db6e656e0e310ed7ee4ad42904fe2794/contracts/Keep3rV2OracleFactory.sol#L86-L88" rel="external nofollow noopener" target="_blank">actual computation to generate the price data</a> is this:</p> <pre><code class="language-solidity">amountOut = amountIn * (end - start) / e10 / elapsed;
</code></pre> <p>With the parameters used in the call to <code class="language-plaintext highlighter-rouge">_computeAmountOut</code> in <code class="language-plaintext highlighter-rouge">current()</code> we can see that expanded to:</p> \[\text{amountOut} = \text{amountIn} \times \frac{\text{pool.price0CumulativeLast} - \text{lastObservation.price0Cumulative}}{\text{pool.lastCumulativePriceTimestamp} - \text{observation.lastObservationTimestamp}}\] <p>If we expand the values in the equation, <a href="https://inspexco.medium.com/inverse-finances-incident-analysis-inv-price-manipulation-b15c2e917888#:~:text=When%20putting%20every%20parameter%20into%20the%20calculation%20of%20_computeAmountOut()%20function" rel="external nofollow noopener" target="_blank">then cancel like terms</a>, the resulting equation becomes:</p> \[\text{amountOut} = \text{amountIn} \times \text{pool.price0CumulativeLast}\] <p>Any defenses provided by Keep3r’s TWAP were disabled completely.</p> <h3 id="aftermath">Aftermath</h3> <p>In all, these vulnerabilities were missed chances to use a more robust source of fair market value with a more secure TWAP. $15 million was lost by Inverse and the lending pools were frozen The Frontier protocol was shut down and replaced with a new one. Since, inverse has been making <a href="">regular payments to compensate affected users</a>.</p> <h2 id="what-to-ask-for-next-time">What to ask for next time</h2> <p>In Part II of this series, we’ll examine more deeply the questions security-minded developers and auditors can ask while encountering price oracles.</p> <p>What kind of questions can help uncover this kind of flaw?</p> <ul> <li>Is the time window on the TWAP wide enough to handle the expected volatility?</li> <li>Could the oracle be getting data from a single, thinly-traded pool?</li> <li>Is there sufficient market coverage to be sure the prices reflect fair market value?</li> <li>How many price feeds would be necessary to make a price manipulation attack prohibitively expensive?</li> <li>Is the chain we use more or less susceptible to MEV?</li> <li>Have we exhausted our list of possible attacks to our oracle systems and audited the code to invalidate them?</li> <li>Are there any circuit-breakers in place to prevent attackers from using manipulated prices?</li> </ul> <p>Stay tuned for Part II.</p> <p>– Alex Perez (reentrant)</p> </d-article><div class="social"> <div class="contact-icons"> <a href="mailto:%61%6C%65%78%61%6E%64%65%72%6C%70%65%72%65%7A@%67%6D%61%69%6C.%63%6F%6D" title="email"><i class="fas fa-envelope"></i></a> <a href="https://github.com/0xreentrant" title="GitHub" rel="external nofollow noopener" target="_blank"><i class="fab fa-github"></i></a> <a href="https://www.linkedin.com/in/alexanderlperez" title="LinkedIn" rel="external nofollow noopener" target="_blank"><i class="fab fa-linkedin"></i></a> <a href="https://twitter.com/0xreentrant" title="Twitter" rel="external nofollow noopener" target="_blank"><i class="fab fa-twitter"></i></a> <a href="https://discord.com/users/reentrant" title="Discord" rel="external nofollow noopener" target="_blank"><i class="fab fa-discord"></i></a> </div> </div> </div> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> </body> </html>